### Схема и монтаж

Основные компоненты станций: микроконтроллер - Atmega328p-au, RFID-модуль RC522, часы DS3231. Питание от 3х батареек АА через линейный стабилизатор MCP1700T-33. Схему и плату можно посмотреть в [Upvertet](https://upverter.com/AlexanderVolikov/a6d775cd45a22968/Sportiduino-MarkStantion/)

![Принципиальная схема](https://raw.githubusercontent.com/alexandervolikov/sportIDuino/master/Base%20station/Scheme.jpg)

Монтаж компонентов проходит на печатной плате, с платой RFID соединение спайкой через штырьковый разъём. Можно заказать изготовление плат в Китае, за партию в 30 плат это обойдётся порядка 50 рублей за штуку с доставкой, гербер файлы есть в папке mark stantion. 

![](https://raw.githubusercontent.com/alexandervolikov/sportiduino/master/Base%20station/PCB.JPG)

Интерфейс реализовал на разъеме PBD-6, 6 контактов в два ряда. В качестве коробки g1020BF. В коробке сверлится дырка для светодиода и срезается лишний пластик, чтобы влез батарейный отсек.

[Про сборку и первоначальную настройку станции отметки написано тут](https://github.com/alexandervolikov/sportiduino/blob/master/Doc/ru/BaseStationAssembly.md)

### Потребление
Для уменьшения потребления во время ожидания соревнований, реализован режим Sleep mode для контроллера а также для RC522, при этом потребляется 0.02 мА (на плате RFID необходимо выпаять/выломать светодиод и подтягивающий резистр к линии RST и заменить индуктивности). Во время работы датчика потребляется до 20 мА (до 40 мА во время считывания-записи), один цикл опроса карточки занимает до 20 мс. 

По умолчанию станция запускается в режиме ожидания. При этом происходит считывание чипов раз в cекунду. Интегральное потребление до 0.5 мА. Полностью заряженных батарей хватит на 160 дней. При подносе чипа (это делает судья-установщик или первый спортсмен) станция переходит в рабочий режим, по-умолчанию, после 6 часов бездействия возвращается обратно в режим ожидания (время можно менять с помощью байта настроек см. ниже).

В рабочем режиме реализовано вхождение в сон каждые 250 мс, таким образом, во время работы можно ожидать интегральное потребление порядка 1,7 мА. Полностью заряженных батарей хватит на 45 дней непрерывной работы.

При подносе мастер чипа (UID заданно в прошивке станции) станция переходит в режим сна (вхождение в сон на 8 секунд), пикает 3 раза и перезагружается. В режиме сна станция интегрально потребляет  0.02 мА. Полностью заряженных батарей хватит на 5 лет. При подносе любого чипа станция переходит в режим ожидания, при этом происходит измерение оставшегося заряда батареи (3 сигнала - заряд меньше 15%, 1 сигнал - заряд больше 15%), затем происходит перезагрузка

### Первоначальная настройка.
При использовании прошивок, где используется watch-dog (avr/wdt.h) необходимо перезалить Bootloder на микроконтроллере, чтобы он корректно работали. Прошивка и инструкции здесь: https://github.com/Optiboot/optiboot

Также для работы нужно установить библиотеки DS3231 и RC522, в последней изменены некоторые параметры (время выхода из спящего режима уменьшено с 50 мс до 1мс). Ещё следует изменить библиотеку wire в папке, куда уставлен Arduino IDE (чтобы станция продолжала работу при поломке линии i2c, а не уходила в бесконечный цикл). файлы находится в папке Arduino_Scetches/!library

После пайки всех компонентов нужно залить Bootloader, я осуществлял это с помощью другой ардуино через специальную прошивку Arduino as isp, подключал контакты SPI через штырьки, ведущие к RFID модулю

### Прошивка (Stantion)
После подачи входит в режим ожидания: станция просыпается каждую секунду и ищет метку. При обнаружении чипа переходит в рабочий режим с опросом чипа каждые 0.25 секунды.

При подносе чипа, станция считывает 1-ый блок чипа, где хранится номер чипа или отметка мастер-чипа, в случае нахождения которой происходит их обработка. Если чип является обычным, то происходит поиск последней записанной страницы и считывание номера станции в последней отметке. Если номер станции совпадает, то станция просто пикает. Если номер отличный, то производится запись отметки в блок следующую после записанного. В случае успеха, станция подает сигнал, а также записывает факт отметки во внутреннюю EEPROM память станции (в бит, соответствующий номеру чипа)

Во время работы запущен watch-dog, который при зависании системы её перезагружает. 

Корректировка времени на станциях осуществляется с помощью специального чипа. Для этого он прикладывается к станции сопряжения с корректным временем и через три секунды к станции отметки. Также возможна корректировка номера станции, производится аналогично с помощью чипа сначала прикладываемого к станции сопряжения, в которой новый номер вводится через Serial порт, а затем прикладывая к станции отметки, записывается в EEPROM память станции. Для снятие записанных в EEPROM память данных о отмеченных номеров чипов передается с помощью dump-чипа

![](https://raw.githubusercontent.com/alexandervolikov/sportiduino/master/Images/Stantion-blockscheme.png)

Байт настроек. Программируется с помощью мастер-чипа настроек. Отвечает за продолжительность рабочего режима согласно таблице ниже и за режим работы станций – с или без отдельных станций старта и финиша. Во включенном режиме станция старта (номер = 240) будет принимать только очищенные чипы, другие станции будут реагировать на чип только с отметкой на стартовой станции, а после станции финиша (номер =245) чипом уже будет нельзя отметиться на других станциях до очистки. Это позволит избежать досадных ошибок и случайностей. В будущем, возможно, функционал будет развиваться. По умолчанию, байт настроек равен 0.

![](https://raw.githubusercontent.com/alexandervolikov/sportiduino/master/Images/Setting-byte.PNG)

### Станция очистки.

Для перевода станции в режим очистки нужно задать станции номер 249.
В режиме очистки станция проводит очистку всех страниц чипа кроме страницы с номером чипа и страниц заданной информации. То есть, стираются все отметки, заданный номер чипа остается прежним. В страницу времени инициализации записывается новое время, которые используется при обсчете результатов, поэтому важно чтобы время на станции было корректным.

При поднесении чипа, на станции загорается светодиод и горит всё время очистки ( около 5 секунд). При успешной очистке станция издает сигнал, светодиод гаснет, чип нужно убрать. Если сигнала не было, очистка не была завершена, нужно повторить процедуру.

### Система паролей. 
Поскольку система открытая и все спецификации доступны каждому, кто-то может записать с помощью NFC-устройства любой мастер-чип. Есть возможность вандализма - перепрограммирование установленных станций. И тут, в отличии от того, если бы станцию просто разбили, может в результаты вкрастся ошибка, которую трудно заметить и которая может повлиять на места. Для защита от этого явления была введена система паролей.

Пароль состоит из трех чисел от 0 до 255 (трех байт). Пароль по-умолчанию - 0,0,0. Для передачи пароля на станцию отметки используется мастер-чип настроек. При прикладывании этого чипа к станции отметки, если старый пароль совпадает, то записывается новый пароль. Все мастер-чипы работают только при правильном пароле в первой строчке. Также копируется байт настроек. Станция пикает два раза и перезагружается. При поднесении чипа сна (с правильным паролем), станция обнуляет пароль и настройки, приводя байты к значению 0,0,0,0. Входит в режим сна и перезагружается. Информацию о паролях и настройке станции хранят в EEPROM памяти. 

### Каллибровка часов
Существует проблема с некоторыми микросхемами часов - они начинают ощутимо идти неправильно. Для коррекции этого недостатка предусмотрена каллибровка часов. Которая прибавляет или вычитает 1 секунды через заданный период после последней коррекции часов. Настраивается с помощью мастер-чипа времени тремя байтами. Первый байт (0 - задать новое время без установки поправки часов, 1 - часы опаздывают, 2 - часы спешат, 3 - не проводить коррекцию часов), оставшиеся два байта - время в секундах ( до 64 тысяч) после проходения которых произойдет коррекция.