# Руководство пользователя
 
Данная инструкция несет общий характер и предназначена для пользователей. Более подробная информация по устройству, а также инструкции по сборке находится на гитхабе: https://github.com/alexandervolikov/sportiduino/

## Общая информация

### Чипы

Рекомендованными для использования являются чипы Ntag215. Их памяти хватает на запись 120 отметок c записью полного времени (год-месяц-день-час-минута-секунда). Могут быть выполнены в разном форм-факторе. Отдельные чипы могут неуверенно срабатывать на станциях, зависит от площади антенны.

### Базовые станции

Представляют собой небольшие коробочки с фланцами, весят около 150 грамм. Питание от 3 батареек АА, в зависимости от режима работы батареек хватает от 45 дней до 2 лет. Кнопок и другого интерфейса на станции нет, весь обмен информацией, запись чипов происходит в бесконтактном режиме, оптимальная зона срабатывания 0.5-1 см над оранжевой наклейкой. В станции установлены часы, обладающие малой погрешностью хода, но станции не являются прибором точного времени, время нужно регулярно корректировать. 

Для обеспечения более длительной работы от батареи базовые станции могут работать в трех режимах:

* Спящий режим. Для хранения станций между соревнованиями. Опрос чипа происходит раз в 25 секунд. Практически не потребляют энергию. Батарей хватит более чем на 2 года. Для перевода в данный режим используются специально записанные мастер-чипы. Вывод осуществляется прикладыванием любого чипа. Также при выводе из сна происходит очистка внутренней памяти
* Режим ожидания. Опрос чипа раз в 1 секунду. По умолчанию, при отметке чипом переходит в рабочий режим. Батарей хватит примерно на полгода.
* Рабочий режим. Опрос чипа раз в 0.25 секунд. Самый быстрый режим отметки. Батарей хватит на 45 дней. По умолчанию, при бездействии более 6 часов переходит в режим ожидания.

Базовые станции в зависимости от заданного им номера (число от 1 до 255) могут выполнять разные функции:

1-239 - обычные станции отметки. При поднесении чипа записывают в него новые данные и выдают сигнал. При повторном поднесении чипа не производят запись, выдают сигнал. В режиме работы станции старта/финиша не производят отметку и не сигналят для чипов, которые не стартовали или не финишировали.

240 – станция старта. В режиме работы станции старта/финиша не производят отметку и не сигналят, если чип не пустой. В обычном режиме работают как обычные базовые станции

245 – станция финиша. Работает как обычная базовая станция

248 – станция проверки. Если чип пустой и время его инициализации/очистки не отстает более чем на месяц от текущего, станция пикает один раз, иначе – три. Станция ничего не записывает на чип и работает по скорости как обычная, так что на ней участники также могут потренироваться в отметке.

249 – станция очистки. Стирает весь чип, оставляя неизменным номер, а также обновляет время инициализации на чипе. При поднесении чипа загорается светодиод и горит все время процедуры очистки, звуковой сигнал говорит об успешности процедуры. При поднесении повторно только что очищенного чипа станция просто издает сигнал.

###Мастер станция

Станция с разъемом USB для подключения к компьютеру нужна для настройки системы, записи и считывания чипов.

## Инструкция для участников

Данную инструкцию целесообразно распечатать крупным шрифтом и повесить для ознакомления участникам на соревнованиях.

* Для отметки нужно поднести чип к области над оранжевой наклейкой.
* В случае успешной отметки станция издаст звуковой сигнал и (или) мигнет светодиодом
* Оптимальный диапазон срабатывания - около 1 см над оранжевой наклейкой. 
* Если подносить чип вплотную, или если чип далеко от станции, отметка может сработать не с первого раза. 
* При отметке не нужно двигать чип из стороны в сторону, это затрудняет чтение и запись чипа.
* Если не получилось отметиться, уберите чип и вновь поднесите его, медленно опуская его к станции над оранжевой наклейкой.
* Время отметки составляет от 0,06 до 0,4 секунды, если станция находится в рабочем режиме.
* Если Вы пришли на станцию первым, её, возможно, нужно разбудить, время отметки в таком случае составит от 0,06 до 1,2 секунды.
* Отметка бесконтактная, ни на что нажимать не нужно.
* При попытке повторной отметки станция произведет более длительный сигнал без записи новой отметки. Если не уверены, отметились ли вы с первого раза, стоит повторить.
* Без отметки на стартовой станции чипы могут не срабатывать, в данном случае нужно вернуться на старт

## Инструкция для постановщиков

Для работы со станциями необходимо использовать программу, написанную на Processing, это подготовка чипов, настройка станций. Чтение чипов рекомендовано делать в более профессиональной программе SportOrg.

Программу на Processing можно скачать в последнем релизе https://github.com/alexandervolikov/sportiduinoProcessing/releases. Нужно установить IDE Processing https://processing.org/ и запускать программу main.pde из под неё, это дополнительно позволит видеть лог-файл в процессе использования программы в окне под кодом. Также  весь лог сохраняется в папку data/log.

### Подключение мастер-станции

Для подключения станции нужно нажать кнопку Connect. Если подключение удалось, появится дополнительные две кнопки, а в логе Proceesing отобразится "Open com". 
Если подключить станцию не удается, проверьте правильность соединения. Проблемы могут возникнуть, если в системе используется другое устройство, связанное через com порт. В таком случае нужно через Панель управления - Диспетчер устройств выяснить номер com порта, присваиваемый станции и вбить его в setting.csv. Также, станции на Arduino Nano с чипами CHG340 могут не работать без установки соответствующего драйвера.

### Подготовка чипов.

Пустые чипы необходимо инициализировать (записать на них номер и текущее время). Для этого нужно раскрыть меню настроек - нажать кнопку Setting. После чего вбить номер чипа с помощью клавиатуры (можно использовать только клавиши цифр, расположенные над буквенными, а также кнопки Backspace и delete). Поднести чип к станции и нажать кнопку Initialize. Процесс инициализации занимает в зависимости от чипа от 3 до 7 секунд. В случае успеха станция издаст один сигнал, число в поле ввода увеличится на 1. Если процесс прошел неудачно (три коротких сигнала и один длинный), попробуйте повторить процедуру.

Номер чипа можно задать в диапазоне от 1 до 65535. Но базовые станции при отметке чипов с номером более 4000 не будут запоминать факт их отметки, поэтому рекомендуется ограничиться номерами до 4000.

При инициализации помимо номера чипа записывается и время инициализации, которое необходимо для последующего считывания чипа, если с момента инициализации или очистки прошло более полугода, данные будут некорректными. Поэтому желательно инициализировать чипы не за долго до соревнований.
Уже ранее инициализированные чипы можно очистить с сохранением номера на станции очистки (нужно присвоить базовой станции номер 249, а также обновить на станции время).
Подготовка станций

Для настройки станций используются мастер-чипы. Мастер-чип – это обыкновенный чип с записанными на него данными для передачи их на базовую станцию. Чтобы записать мастер-чип, нужно поднести его к мастер-станции и нажать нужную кнопку в зависимости от задачи. Рекомендуется отобрать чип специально для использования в этих целях и как-нибудь его пометить, чтобы избежать попадание его в кучу с чипами участниками, так как в этом случае возможны различные неожиданные ситуации, если чип окажется активным. После каждого использования чипа, он деактивируется, необходимо его записывать каждый раз при использовании.

Для настройки станций, если они находится в состоянии сна, необходимо их сначала разбудить – поднести любой чип на время до 30 секунд. Произойдет процедура выхода из состояния сна: на 5 секунд загорится светодиод, станция измерит заряд батарей (если заряд нормальный выдаст один длинный сигнал, если батарейки нужно заменить пять коротких). После чего перезагрузится и через 5 секунд издаст один короткий сигнал. Если станция издаст три коротких сигнала за 5 секунд до длинного, то на ней часы идут неверно, их нужно настроить.

### Настройка времени станции

Для настройки времени нужно приложить чип к мастер-станции и нажать Time Master. Станция издаст три сигнала с интервалом в секунду. После второго сигнала нужно приложить чип к базовой станции. При этом станция издаст 3 сигнала и перезагрузится. Если последний сигнал мастер станции и первый сигнал базовой станции слились в один, то время настроено достаточно точно. Настройку времени лучше проводить в рабочем режиме станции в виду более короткого периода неактивности станции.

Погрешность хода часов (при условии использования качественных компонентов и соблюдения технологии пайки) составляет 1 секунду в неделю. Для критически важных станций – старта, финиша рекомендуется обновлять время в день соревнований.

### Присвоение номера станции

Набрать номер станции с помощью клавиатуры (можно использовать только клавиши цифр, расположенные над буквенными, а также кнопки Backspace и delete). Поднести чип к станции и нажать кнопку Num Master. После чего данный чип поднести к станции. Станция издаст 5 сигналов и перезагрузится с новым номером. 

Часть номеров станций используются в специальных целях:
240 – станция старта
245 – станция финиша
248 – станция проверки
249 – станция очистки

### Перевод станций в спящий режим

После соревнований рекомендуется перевести все станции в спящий режим для продления работы от батарей. Для этого нужно поднести чип к мастер-станции, нажать Sleep Master и поднести его к базовой станции. Станция издаст 4 сигнала, перезагрузится и войдёт в спящий режим. Для вывода станций из этого режима нужно приложить к ней чип на время до 30 секунд.

### Настройка станции

В режиме по умолчанию станция не использует пароли, отдельные стартовые и финишные станции, не проверяет время инициализации, объем чипа определяется автоматически, а время перехода из рабочего режима в режим ожидания равен 6 часам, пароли не используются. Если данные параметры не устраивают, то их можно настроить. Для этого перед включением программы нужно открыть файл setting.csv. И задать нужные параметры, после чего сохранить. Далее включить программу, поднести чип и нажать Pass Master. Мастер-станция издаст два сигнала, поднести чип к базовой станции, которая также издаст два сигнала и перезагрузится.

Использование паролей защищает станции от возможности их программирования чужими мастер-чипами с неверным паролем, что может защитить от подобного вандализма. Для использования паролей нужно ввести три байта старого пароля (числа от 0 до 255). По умолчанию, это три нуля. Также следует учесть, что при переводе станций в режим сна, пароль сбрасывается на пароль по умолчанию 0,0,0. Ввести новый пароль также состоящий из трех байт.

Байт настроек станции setSt - число от 0 до 255, содержащие в себе биты настройки, отвечающие за те или иные функции, по умолчанию - 0. Выход в сон также сбрасывает настройки вместе с паролями.

формула байта настроек:

setSt = a + b + c + d, где

Время перехода в режим ожидания
a = 0, через 6 часов
a = 1, через 24 часа
a = 2, всегда в режиме ожидания
a = 3, всегда в рабочем режиме

Режим работы со специальными станциями старта и финиша
b = 0, без специальной станции старта и финиша
b = 4, со специальной станцией старта и финиша

Проверка просроченности чипов
c = 0, не проверять время инициализации чипа
с = 8, не отмечать чипы, которые инициализированы давно

Максимальное число отметок в чипе
d = 0, максимальное число отметок определяется типом чипа автоматически
d = 16, максимальное число отметок = 32
d = 32, максимальное число отметок = 64
d = 48, максимальное число отметок = 120

Например, хотим, чтобы станция переходила в режим ожидания через 6 часов, работала со станцией старта и финиша, не проверяла время инициализации чипа, максимальное число отметок = 64, тогда
a = 0, b = 4, c = 0, d = 32
SetSt = 0 + 4 + 0 + 32 = 36

### Снятие лога станции

В ходе работы базовая станция ведет лог – записывает факт отметки теми или иными номерам чипов. Время отметки при этом не записывается, лог ведется только для чипов с номерами до 4000. С использованием этой функции возможно восстановление части данных в случае утери чипов, проверки спорных ситуаций, а также в поиске сошедших или потерявшихся участников.
Перед работой нужно подготовить файлы. Для этого зайти в папку data/dump. Удалить файл dump.csv, сделать копию файла dump – Copy.csv и переименовать её в dump.csv. После чего можно запускать программу.

Для снятия лога нужно записать мастер-чип, для этого поднести чип к мастер станции и нажать Log Master. Процесс подготовки мастер-чипа занимает 5 секунд. После чего поднести мастер чип к базовой станции. Процесс длительный, нужно аккуратно держать чип в оптимальной области записи (0.5 - 1 см над оранжевой меткой). После успешного снятия лога поднести чип к мастер-станции и нажать Read Log. Результат появится в файле data/damp/dump.csv в виде большой матрицы номер чипа/ номер станции. Для удобства работы после снятия всех логов рекомендуется удалить нерабочие диапазоны номеров станций и чипов.

## Чтение чипов, формирование результатов SportOrg

Для чтения чипов и формирования результатов рекомендуется использовать программу SportOrg. Особенность использования данной программы заключается в том, что необходимо использовать стартовую станцию (240) и финишную станцию (245), иначе при чтении будет происходить ошибка. Можно предварительно отметить все чипы на станции старта, раздать участникам, а дальше в программе задать время старта либо задать отсчет старта от произвольной станции. Также можно перевести станции в режим работы со станциями старта/финиша, чтобы избежать ошибки.

Скачать последнюю версию и изучить инструкции можно на сайте:
http://sportorg.o-ural.ru/

## Чтение чипов, формирование результатов Processing

Для опытных пользователей.
Использование данной программы нетривиально и может показаться сложным в освоении. К тому же требуется ещё дополнительная постобработка данных для формирования финишных протоколов. Поэтому её использование не рекомендуется. Тем не менее, опытные пользователи (особенно обладающие навыками программирования) могут, используя её, проводить соревнования в нужном для них формате. 

### Подготовка

Если подведение результатов не предполагается, а нужно лишь узнать что записалось на чипе, настройку можно пропустить. Данные при чтении будут показываться в логе Processing.
Перед работой нужно подготовить файлы. Для этого зайти в папку data/. Удалить файлы correct.csv, protocol.csv, сделать копии файлов correct - Copy.csv и protocol – Copy, переименовать их в correct.csv, protocol.csv. Зайти в папку data/result. Удалить все файлы кроме alldata – Copy.csv, сделать его копию и переименовать её в alldata.csv.
В файле data/protocol нужно вбить стартовый протокол. Важно соблюдать имеющуюся таблицу, нельзя добавлять/удалять изменять названия столбцов. Сохранять необходимо в формате csv, кодировка - UTF-8, разделители – запятая. Удобно это делать с использованием Libre Office (в Excel более затруднительно).

В файл correct.csv внести нужные коррекции, если это необходимо. Аналогично, необходимо соблюдать заданный формат. Для корректировки кп нужно его добавить в таблицу. St - номер кп. plus - прибавить время в секундах к кп. minus - вычесть время в секундах к кп. newSt - заменить номер кп. Если поставить больше 250, то это кп удалится из сплитов.
Можно всем чипам принудительно выставить старт. Нужно в случае общего старта (например беговые старты или рогейны) для этого нужно в столбце newSt набрать 0, а в графе plus – время старта в формате unixtime. Всем в начале чипа добавится взятие станции 240 (старт) со временем plus.

### Считывание чипов

Для чтения поднести чип к мастер-станции и нажать Read Chip. Длительность чтения зависит от чипа и занимает от 1 до 4 секунд. В случае успешного чтения станция издаст сигнал. В логе будут показаны результаты: времена отметок на кп а также число взятых кп (минус старт и финиш), общее время на дистанции (финиш-старт). 
Сырые данные сохраняться в data/result/alldata.csv в виде взятого кп и соответствующего времени в формате unixtime. Каждое считывание записывается в новую строку, при повторном считывании чипа в результатах обсчитывается только последнее считывание. При выключении программы данные не удаляются. При последующем включение данные с чипов продолжаться записываться с сохранением уже записанных ранее.

### Получение первичных результатов

Обработку результатов можно проводить как постепенно по мере считывания чипов, так и после считывания всех чипов. Для обработки нет необходимости подключения мастер-станции. 
Нужно нажать кнопку Calc, в результате в папке data/result появятся два файла – correct.csv и result.csv. В первом находятся скорректированные согласно файлу data/correct.csv сырые данные. Во втором – подсчитанные результаты без сортировки. При каждом нажатии кнопки Calc создаются новые файлы, старые при этом удаляются.

Обсчёт результатов может занять длительное время. Но также может и зависнуть, если что-то было сделано неправильно (неправильно заполненные таблицы в первую очередь), в таком случае в окне Processing IDE появится сообщение об ошибке. Нужно выключить программу, нажав кнопку стоп в IDE.

### Постобработка. Формирование протоколов

В файле data/result/result.csv в результате обработки появятся результаты без сортировки. Номерам чипов будут отнесены данные из протокола. Если считанного номера чипа нет в протоколах, то соответственные данные останутся пустыми. Также участники из протокола, для которых нет считанных чипов, будут скопированы в конец результатов. Все временные данные в результатах представлены в формате число_секунд/86400, что соответствует стандартному представлению времени в табличных редакторах, чтобы перевести в привычный вид в табличном редакторе нужно выделить столбцы с временами и сменить формат ячеек на отображение времени. Со временем в данном формате можно проводить арифметические операции.

Результаты содержат следующие столбцы помимо скопированных из протокола:

* Time – общее время на дистанции (время финиша – время старта)
* CP – число взятых КП, исключая стартовую и финишную станцию
* Rogein – сумма первых цифр взятых кп, исключая специальные станции старта и финиша и повторно взятые кп.
* TStart – время старта
* TFinish – время финиша
* С0 – номер стартовой станции

Далее идут сплиты:

* С1 – номер первого взятого КП
* T1 – время перегона со старта до первого КП
* С2 – номер второго взятого КП
* T2 – перегона от первого до второго КП

И так далее.

Ненужные колонки можно удалить и далее рассчитывать результаты с использованием табличного редактора, рассчитать штрафы за выход за кв, очки за взятие кп или пропуск кп и прочее. Удобно использовать авто фильтр для сортировки по группам, по времени, очкам для присвоения мест.

Расчёт специальных дистанций (заданное направление, учет промежуточных финишей…) в данной версии программы не предусмотрен. Но, имея некоторые навыки программирования, можно модифицировать программу под расчет нужных значений.
